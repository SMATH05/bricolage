{% extends 'base.html.twig' %}

{% block title %}
	{{ 'Feed Social'|trans }} | Bricolage
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		/* Feed Container */
		.feed-container {
			max-width: 800px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		/* Create Post Section */
		.create-post-section {
			background: white;
			border-radius: 24px;
			padding: 32px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			margin-bottom: 32px;
			border: 1px solid #e2e8f0;
		}

		.create-post-header {
			display: flex;
			align-items: center;
			gap: 16px;
			margin-bottom: 24px;
		}

		.user-avatar {
			width: 50px;
			height: 50px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: white;
			font-size: 1.2rem;
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
		}

		.create-post-input {
			flex: 1;
			background: #f8f9fa;
			border: 2px solid #e2e8f0;
			border-radius: 20px;
			padding: 16px 20px;
			font-size: 1rem;
			transition: all 0.3s ease;
			cursor: pointer;
		}

		.create-post-input:hover {
			border-color: #667eea;
			background: white;
		}

		.create-post-actions {
			display: flex;
			gap: 16px;
			justify-content: center;
			padding-top: 20px;
			border-top: 1px solid #e2e8f0;
		}

		.action-btn {
			background: transparent;
			border: none;
			border-radius: 16px;
			padding: 12px 20px;
			font-weight: 600;
			color: #64748b;
			transition: all 0.3s ease;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.action-btn:hover {
			background: #f8f9fa;
			transform: translateY(-2px);
		}

		.action-btn.photo { color: #10b981; }
		.action-btn.video { color: #3b82f6; }

		/* Post Cards */
		.post-card {
			background: white;
			border-radius: 24px;
			overflow: hidden;
			margin-bottom: 32px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			border: 1px solid #e2e8f0;
			transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
		}

		.post-card:hover {
			transform: translateY(-8px);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
		}

		.post-header {
			padding: 24px;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.post-author {
			display: flex;
			align-items: center;
			gap: 16px;
		}

		.author-avatar {
			width: 45px;
			height: 45px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: white;
			font-size: 1rem;
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
		}

		.author-info h6 {
			margin: 0;
			font-weight: 700;
			color: #1e293b;
			font-size: 1.1rem;
		}

		.author-info small {
			color: #64748b;
			font-size: 0.9rem;
		}

		.post-content {
			padding: 0 24px 24px;
		}

		.post-text {
			color: #374151;
			line-height: 1.6;
			font-size: 1.05rem;
			margin-bottom: 20px;
		}

		.post-media {
			border-radius: 16px;
			overflow: hidden;
			margin-bottom: 20px;
			background: #f8f9fa;
		}

		.post-media img,
		.post-media video {
			width: 100%;
			max-height: 600px;
			object-fit: cover;
			transition: transform 0.6s ease;
		}

		.post-card:hover .post-media img,
		.post-card:hover .post-media video {
			transform: scale(1.02);
		}

		.post-actions {
			padding: 20px 24px;
			border-top: 1px solid #e2e8f0;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.action-buttons {
			display: flex;
			gap: 24px;
		}

		.action-button {
			background: transparent;
			border: none;
			padding: 8px 16px;
			border-radius: 12px;
			font-weight: 600;
			color: #64748b;
			transition: all 0.3s ease;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.action-button:hover {
			background: #f8f9fa;
			transform: translateY(-2px);
		}

		.action-button.liked {
			color: #ef4444;
		}

		.action-button i {
			font-size: 1.2rem;
		}

		/* Modal Styles */
		.modal-content {
			border-radius: 24px;
			border: none;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
		}

		.modal-header {
			border-bottom: 1px solid #e2e8f0;
			padding: 24px;
		}

		.modal-body {
			padding: 24px;
		}

		.form-control {
			border: 2px solid #e2e8f0;
			border-radius: 16px;
			padding: 16px 20px;
			font-size: 1rem;
			transition: all 0.3s ease;
		}

		.form-control:focus {
			border-color: #667eea;
			box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
			outline: none;
		}

		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border: none;
			border-radius: 16px;
			padding: 12px 24px;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
		}

		/* Animations */
		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes slideInLeft {
			from {
				opacity: 0;
				transform: translateX(-30px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		@keyframes pulse {
			0%, 100% {
				transform: scale(1);
			}
			50% {
				transform: scale(1.05);
			}
		}

		.animate-fade-in {
			animation: fadeInUp 0.6s ease-out;
		}

		.animate-slide-up {
			animation: slideInLeft 0.5s ease-out;
		}

		.animate-pulse {
			animation: pulse 2s infinite;
		}

		/* Responsive */
		@media (max-width: 768px) {
			.feed-container {
				padding: 20px 16px;
			}

			.create-post-section {
				padding: 24px;
				border-radius: 20px;
			}

			.post-header {
				padding: 20px;
			}

			.post-content {
				padding: 0 20px 20px;
			}

			.post-actions {
				padding: 16px 20px;
			}

			.action-buttons {
				gap: 16px;
			}
		}
	</style>
{% endblock %}

{% block body %}
	<div class="feed-container">
		{% if app.user %}
			<!-- Create Post Section -->
			<div class="create-post-section animate-slide-up">
				<div class="create-post-header">
					<div class="user-avatar">
						{% if app.user.prenom and app.user.nom %}
							{{ app.user.prenom|slice(0, 1)|upper }}{{ app.user.nom|slice(0, 1)|upper }}
						{% else %}
							{{ app.user.userIdentifier|slice(0, 1)|upper }}
						{% endif %}
					</div>
					<div class="create-post-input" data-bs-toggle="modal" data-bs-target="#createPostModal">
						{{ 'Partagez vos travaux...'|trans }}
					</div>
				</div>
				<div class="create-post-actions">
					<button class="action-btn photo" data-bs-toggle="modal" data-bs-target="#createPostModal">
						<i class="fas fa-image"></i>
						{{ 'Photo'|trans }}
					</button>
					<button class="action-btn video" data-bs-toggle="modal" data-bs-target="#createPostModal">
						<i class="fas fa-video"></i>
						{{ 'Vidéo'|trans }}
					</button>
				</div>
			</div>
		{% endif %}

		<!-- Posts Feed -->
		{% for post in posts %}
			<div class="post-card animate-fade-in">
				<!-- Post Header -->
				<div class="post-header">
					<div class="post-author">
						<div class="author-avatar">
							{% if post.author.prenom and post.author.nom %}
								{{ post.author.prenom|slice(0, 1)|upper }}{{ post.author.nom|slice(0, 1)|upper }}
							{% else %}
								{{ post.author.userIdentifier|slice(0, 1)|upper }}
							{% endif %}
						</div>
						<div class="author-info">
							<h6>
								{% if post.author.prenom and post.author.nom %}
									{{ post.author.prenom }} {{ post.author.nom }}
								{% else %}
									{{ post.author.userIdentifier }}
								{% endif %}
							</h6>
							<small>{{ post.createdAt|date('d/m/Y H:i') }}</small>
						</div>
					</div>
					<div class="dropdown">
						<button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown" aria-expanded="false">
							<i class="fas fa-ellipsis-h"></i>
						</button>
						<ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm mt-2" aria-labelledby="dropdownMenu{{ post.id }}">
							<li>
								<a class="dropdown-item" href="#">
									<i class="fas fa-bookmark me-2"></i>
									{{ 'Sauvegarder'|trans }}
								</a>
							</li>
							<li>
								<a class="dropdown-item" href="#">
									<i class="fas fa-share me-2"></i>
									{{ 'Partager'|trans }}
								</a>
							</li>
							<li><hr class="dropdown-divider"></li>
							<li>
								<a class="dropdown-item text-danger" href="#">
									<i class="fas fa-flag me-2"></i>
									{{ 'Signaler'|trans }}
								</a>
							</li>
						</ul>
					</div>
				</div>

				<!-- Post Content -->
				<div class="post-content">
					{% if post.content %}
						<p class="post-text">{{ post.content }}</p>
					{% endif %}

					{% if post.media %}
						<div class="post-media">
							{% if post.mediaType == 'image' %}
								<img src="/uploads/posts/{{ post.media }}" 
									 alt="Post media" 
									 onerror="this.parentElement.innerHTML='<div class=\"text-center p-4\"><i class=\"fas fa-exclamation-triangle fa-3x text-warning\"></i><br><small>Image non disponible</small></div>';">
							{% elseif post.mediaType == 'video' %}
								{% set _ext = post.media|split('.')|last|lower %}
								{% set _mime = _ext == 'mp4' ? 'video/mp4' : (_ext == 'webm' ? 'video/webm' : ((_ext == 'ogg' or _ext == 'ogv') ? 'video/ogg' : (_ext == 'mov' ? 'video/quicktime' : 'application/octet-stream'))) %}
								<video controls preload="metadata" onerror="this.parentElement.innerHTML='<div class=\"text-center p-4\"><i class=\"fas fa-exclamation-triangle fa-3x text-warning\"></i><br><small>Vidéo non disponible</small></div>';">
									<source src="/uploads/posts/{{ post.media }}" type="{{ _mime }}">
									{{ 'Votre navigateur ne supporte pas la balise vidéo.'|trans }}
								</video>
							{% endif %}
						</div>
					{% endif %}
				</div>

				<!-- Post Actions -->
				<div class="post-actions">
					<div class="action-buttons">
						<button class="action-button post-action-like animate-pulse" data-id="{{ post.id }}">
							<i class="far fa-heart"></i>
							<span>{{ 'J\'aime'|trans }}</span>
						</button>
						<button class="action-button" data-bs-toggle="modal" data-bs-target="#commentModal{{ post.id }}">
							<i class="far fa-comment"></i>
							<span>{{ 'Commenter'|trans }}</span>
						</button>
					</div>
					<div class="likes-count">
						<span id="likes-count-{{ post.id }}">{{ post.likes|length }}</span> {{ 'J\'aime'|trans }}
					</div>
				</div>
			</div>
		{% endfor %}

		{% if not app.user %}
			<!-- Welcome Section -->
			<div class="text-center py-5 animate-fade-in">
				<div class="user-avatar mb-4" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto;">
					<i class="fas fa-hammer"></i>
				</div>
				<h2 class="mb-3">{{ 'Bienvenue sur Bricolage'|trans }}</h2>
				<p class="text-muted mb-4">{{ 'Rejoignez la communauté pour partager vos projets et découvrir ceux des autres.'|trans }}</p>
				<div class="d-flex gap-3 justify-content-center">
					<a href="{{ path('app_register') }}" class="btn btn-primary btn-lg rounded-pill px-5 py-3">
						<i class="fas fa-user-plus me-2"></i>
						{{ 'Inscription'|trans }}
					</a>
					<a href="{{ path('app_login') }}" class="btn btn-outline-primary btn-lg rounded-pill px-4 py-3">
						<i class="fas fa-sign-in-alt me-2"></i>
						{{ 'Connexion'|trans }}
					</a>
				</div>
			</div>
		{% endif %}
	</div>

	<!-- Create Post Modal -->
	<div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="createPostModalLabel">{{ 'Créer une publication'|trans }}</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form method="POST" action="{{ path('app_social_post') }}" enctype="multipart/form-data">
						<div class="mb-3">
							<label for="content" class="form-label">{{ 'Que voulez-vous partager ?'|trans }}</label>
							<textarea name="content" class="form-control" rows="4" placeholder="{{ 'Décrivez votre projet...'|trans }}"></textarea>
						</div>
						<div class="mb-3">
							<label class="form-label">{{ 'Ajouter un média'|trans }}</label>
							<input type="file" name="media" class="form-control" accept="image/*,video/*">
						</div>
						<div class="preview-container mb-3 d-none">
							<!-- Preview will be inserted here -->
						</div>
						<button type="submit" class="btn btn-primary w-100">{{ 'Publier'|trans }}</button>
					</form>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	<script>
		// Like functionality
		document.querySelectorAll('.post-action-like').forEach(button => {
			button.addEventListener('click', function(e) {
				e.preventDefault();
				const postId = this.dataset.id;
				const icon = this.querySelector('i');
				const countSpan = document.getElementById(`likes-count-${postId}`);

				fetch(`/social/like/${postId}`, {
					method: 'POST',
					headers: {'X-Requested-With': 'XMLHttpRequest'}
				})
				.then(response => response.json())
				.then(data => {
					if (data.liked) {
						icon.classList.remove('far');
						icon.classList.add('fas');
						this.classList.add('liked');
					} else {
						icon.classList.remove('fas');
						icon.classList.add('far');
						this.classList.remove('liked');
					}
					countSpan.textContent = data.likesCount;
				})
				.catch(error => console.error('Error:', error));
			});
		});

		// File preview
		const mediaInput = document.querySelector('input[name="media"]');
		const previewContainer = document.querySelector('.preview-container');

		if (mediaInput) {
			mediaInput.addEventListener('change', function(e) {
				const file = e.target.files[0];
				if (file) {
					const reader = new FileReader();
					reader.onload = function(e) {
						previewContainer.innerHTML = '';
						previewContainer.classList.remove('d-none');

						if (file.type.startsWith('image/')) {
							const img = document.createElement('img');
							img.src = e.target.result;
							img.className = 'img-fluid rounded-3';
							img.style.maxHeight = '200px';
							previewContainer.appendChild(img);
						} else if (file.type.startsWith('video/')) {
							const video = document.createElement('video');
							video.src = e.target.result;
							video.className = 'img-fluid rounded-3';
							video.style.maxHeight = '200px';
							video.controls = true;
							previewContainer.appendChild(video);
						}
					};
					reader.readAsDataURL(file);
				} else {
					previewContainer.innerHTML = '';
					previewContainer.classList.add('d-none');
				}
			});
		}

		// Intersection Observer for animations
		const observerOptions = {
			threshold: 0.1,
			rootMargin: '0px 0px -50px 0px'
		};

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.style.opacity = '1';
					entry.target.style.transform = 'translateY(0)';
				}
			});
		}, observerOptions);

		document.querySelectorAll('.post-card').forEach(card => {
			card.style.opacity = '0';
			card.style.transform = 'translateY(20px)';
			card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
			observer.observe(card);
		});
	</script>
{% endblock %}
