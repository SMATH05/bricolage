{% extends 'base.html.twig' %}

{% block title %}
	{{ 'Messagerie'|trans }}
	| Bricolage
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.chat-wrapper {
			height: calc(100vh - 200px);
			min-height: 600px;
			background: white;
			border-radius: 24px;
			overflow: hidden;
			display: flex;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
		}

		.chat-sidebar {
			width: 350px;
			border-right: 1px solid #f1f5f9;
			display: flex;
			flex-direction: column;
		}

		.chat-main {
			flex: 1;
			display: flex;
			flex-direction: column;
			background: #f8fafc;
		}

		.conversation-list {
			overflow-y: auto;
			flex: 1;
		}

		.conversation-item {
			padding: 20px;
			display: flex;
			align-items: center;
			gap: 15px;
			cursor: pointer;
			transition: all 0.2s;
			text-decoration: none;
			color: inherit;
			border-bottom: 1px solid #f8fafc;
		}

		.conversation-item:hover {
			background: #f1f5f9;
		}

		.conversation-item.active {
			background: #eef2ff;
			border-right: 4px solid var(--accent-primary);
		}

		.user-avatar {
			width: 50px;
			height: 50px;
			border-radius: 12px;
			background: #e2e8f0;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: #64748b;
		}

		.message-bubble {
			max-width: 70%;
			padding: 12px 18px;
			border-radius: 18px;
			margin-bottom: 15px;
			position: relative;
			font-size: 0.95rem;
			line-height: 1.5;
		}

		.message-sent {
			background: var(--accent-primary);
			color: white;
			align-self: flex-end;
			border-bottom-right-radius: 4px;
		}

		.message-received {
			background: white;
			color: #1e293b;
			align-self: flex-start;
			border-bottom-left-radius: 4px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
		}

		.messages-container {
			flex: 1;
			overflow-y: auto;
			padding: 30px;
			display: flex;
			flex-direction: column;
		}

		.chat-input-area {
			background: white;
			padding: 20px 30px;
			border-top: 1px solid #f1f5f9;
		}

		.chat-input-area form {
			display: flex;
			gap: 15px;
			background: #f1f5f9;
			padding: 8px;
			border-radius: 100px;
		}

		.chat-input-area input {
			flex: 1;
			border: none;
			background: transparent;
			padding: 10px 20px;
			outline: none;
		}

		.send-btn {
			width: 45px;
			height: 45px;
			border-radius: 50%;
			background: var(--accent-primary);
			color: white;
			border: none;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.2s;
		}

		.send-btn:hover {
			transform: scale(1.1);
		}

		.chat-header {
			padding: 20px 30px;
			background: white;
			border-bottom: 1px solid #f1f5f9;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container py-5 mt-4">
		<div
			class="chat-wrapper shadow-lg border">
			{# Sidebar #}
			<div class="chat-sidebar">
				<div class="p-4 border-bottom bg-light">
					<h5 class="fw-bold mb-0">{{ 'Conversations'|trans }}</h5>
				</div>
				<div class="conversation-list">
					{% for conv in conversations %}
						<a href="{{ path('app_chat_conversation', {id: conv.user.id}) }}" class="conversation-item {% if activeUser and activeUser.id == conv.user.id %}active{% endif %}">
							<div class="user-avatar shadow-sm">
								{{ conv.user.userIdentifier|slice(0, 1)|upper }}
							</div>
							<div class="flex-grow-1 overflow-hidden">
								<h6 class="mb-1 fw-bold text-truncate">{{ conv.user.userIdentifier }}</h6>
								<p class="text-muted small mb-0 text-truncate">
									{% if conv.lastMessage %}
										{{ conv.lastMessage.content }}
									{% else %}
										{{ "Nouvelle conversation"|trans }}
									{% endif %}
								</p>
							</div>
							{% if conv.lastMessage and activeUser and activeUser.id != conv.user.id and not conv.lastMessage.isRead and conv.lastMessage.recipient == app.user %}
								<div class="bg-primary rounded-circle" style="width: 10px; height: 10px;"></div>
							{% endif %}
						</a>
					{% else %}
						<div class="p-5 text-center text-muted">
							<i class="fas fa-comments fa-3x mb-3 opacity-25"></i>
							<p class="small">{{ "Aucune conversation active."|trans }}</p>
						</div>
					{% endfor %}
				</div>
			</div>

			{# Main Chat Area #}
			<div class="chat-main">
				{% if activeUser %}
					<div class="chat-header">
						<div class="d-flex align-items-center gap-3">
							<div class="user-avatar" style="width: 40px; height: 40px; font-size: 0.9rem;">
								{{ activeUser.userIdentifier|slice(0, 1)|upper }}
							</div>
							<div>
								<h6 class="mb-0 fw-bold">{{ activeUser.userIdentifier }}</h6>
								<small class="text-success fw-bold">En ligne</small>
							</div>
						</div>
						<div>
							<button class="btn btn-light rounded-circle">
								<i class="fas fa-ellipsis-v text-muted"></i>
							</button>
						</div>
					</div>

					<div class="messages-container" id="messagesContainer">
						{% for message in messages %}
							<div class="message-bubble {% if message.sender == app.user %}message-sent{% else %}message-received{% endif %}">
								{{ message.content }}
								<div class="mt-1" style="font-size: 0.65rem; opacity: 0.7; text-align: right;">
									{{ message.createdAt|date('H:i') }}
								</div>
							</div>
						{% endfor %}
					</div>

					<div class="chat-input-area">
						<form action="{{ path('app_chat_send', {id: activeUser.id}) }}" method="POST">
							<input type="text" name="content" autocomplete="off" placeholder="{{ 'Écrivez votre message ici...'|trans }}" required>
							<button type="submit" class="send-btn">
								<i class="fas fa-paper-plane"></i>
							</button>
						</form>
					</div>
				{% else %}
					<div class="flex-grow-1 d-flex flex-column align-items-center justify-content-center text-muted p-5 text-center">
						<div class="glass-card p-5 rounded-circle mb-4" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center;">
							<i class="fas fa-paper-plane fa-4x text-accent-primary opacity-25"></i>
						</div>
						<h4 class="fw-bold text-dark">{{ "Votre Messagerie"|trans }}</h4>
						<p class="max-w-md">{{ "Sélectionnez une conversation ou contactez un vendeur/candidat pour commencer à discuter."|trans }}</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<script>
		// Auto scroll to bottom
const container = document.getElementById('messagesContainer');
if (container) {
container.scrollTop = container.scrollHeight;
}
	</script>
{% endblock %}
