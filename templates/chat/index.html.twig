{% extends 'base.html.twig' %}

{% block title %}
	{{ 'Messagerie'|trans }}
	| Bricolage
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.chat-wrapper {
			height: calc(100vh - 160px);
			min-height: 500px;
			background: white;
			border-radius: 24px;
			overflow: hidden;
			display: flex;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
		}

		.chat-sidebar {
			width: 350px;
			border-right: 1px solid #f1f5f9;
			display: flex;
			flex-direction: column;
			transition: all 0.3s ease;
		}

		.chat-main {
			flex: 1;
			display: flex;
			flex-direction: column;
			background: #f8fafc;
			transition: all 0.3s ease;
		}

		/* Mobile Optimization */
		@media(max-width: 768px) {
			.chat-wrapper {
				height: calc(100vh - 100px);
				border-radius: 0;
				margin: -1.5rem -0.75rem;
			}

			.chat-sidebar {
				width: 100%;
				{% if activeUser %}
					display: none;
				{% endif %}
			}

			.chat-main {
				width: 100%;
				{% if not activeUser %}
					display: none;
				{% endif %}
			}

			.message-bubble {
				max-width: 85%;
			}
		}

		.conversation-list {
			overflow-y: auto;
			flex: 1;
		}

		.conversation-item {
			padding: 15px 20px;
			display: flex;
			align-items: center;
			gap: 15px;
			cursor: pointer;
			transition: all 0.2s;
			text-decoration: none;
			color: inherit;
			border-bottom: 1px solid #f8fafc;
		}

		.conversation-item:hover {
			background: #f1f5f9;
		}

		.conversation-item.active {
			background: #eef2ff;
			border-right: 4px solid var(--accent-primary);
		}

		.user-avatar {
			width: 45px;
			height: 45px;
			border-radius: 12px;
			background: #e2e8f0;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: #64748b;
			flex-shrink: 0;
			overflow: hidden;
		}

		.user-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.search-container {
			padding: 15px 20px;
			background: white;
			border-bottom: 1px solid #f1f5f9;
		}

		.search-input-wrapper {
			position: relative;
			background: #f8fafc;
			border-radius: 12px;
			padding: 8px 15px;
			display: flex;
			align-items: center;
			gap: 10px;
			border: 1px solid transparent;
			transition: all 0.2s;
		}

		.search-input-wrapper:focus-within {
			background: white;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
		}

		.search-input {
			border: none;
			background: transparent;
			outline: none;
			width: 100%;
			font-size: 0.9rem;
		}

		.message-bubble {
			max-width: 75%;
			padding: 12px 18px;
			border-radius: 18px;
			margin-bottom: 15px;
			position: relative;
			font-size: 0.95rem;
			line-height: 1.5;
		}

		.message-sent {
			background: var(--accent-primary);
			color: white;
			align-self: flex-end;
			border-bottom-right-radius: 4px;
		}

		.message-received {
			background: white;
			color: #1e293b;
			align-self: flex-start;
			border-bottom-left-radius: 4px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.02);
		}

		.messages-container {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			display: flex;
			flex-direction: column;
		}

		.chat-input-area {
			background: white;
			padding: 15px 20px;
			border-top: 1px solid #f1f5f9;
		}

		.chat-input-area form {
			display: flex;
			gap: 10px;
			background: #f1f5f9;
			padding: 6px;
			border-radius: 100px;
		}

		.chat-input-area input {
			flex: 1;
			border: none;
			background: transparent;
			padding: 8px 15px;
			outline: none;
			font-size: 0.95rem;
		}

		.send-btn {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: var(--accent-primary);
			color: white;
			border: none;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.2s;
		}

		.chat-header {
			padding: 12px 20px;
			background: white;
			border-bottom: 1px solid #f1f5f9;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.mobile-back-btn {
			display: none;
		}

		@media(max-width: 768px) {
			.mobile-back-btn {
				display: block;
				margin-right: 10px;
			}
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container py-5 mt-4">
		<div
			class="chat-wrapper shadow-lg border">
			{# Sidebar #}
			<div class="chat-sidebar">
				<div class="p-4 border-bottom bg-light">
					<h5 class="fw-bold mb-0">{{ 'Conversations'|trans }}</h5>
				</div>
				<div class="search-container">
					<div class="search-input-wrapper">
						<i class="fas fa-search text-muted small"></i>
						<input type="text" id="chatSearch" class="search-input" placeholder="{{ 'Rechercher...'|trans }}">
					</div>
				</div>
				<div class="conversation-list" id="conversationList">
					{% for conv in conversations %}
						<a href="{{ path('app_chat_conversation', {id: conv.user.id}) }}" class="conversation-item {% if activeUser and activeUser.id == conv.user.id %}active{% endif %}">
							<div class="user-avatar shadow-sm">
								{% if conv.user.chercheur and conv.user.chercheur.photo %}
									<img src="{{ asset('uploads/profiles/' ~ conv.user.chercheur.photo) }}" alt="Avatar">
								{% elseif conv.user.recruteur and conv.user.recruteur.photo is defined and conv.user.recruteur.photo %}
									{# Logic for recruiter photo if exists #}
									{{ conv.user.userIdentifier|slice(0, 1)|upper }}
								{% else %}
									{{ conv.user.userIdentifier|slice(0, 1)|upper }}
								{% endif %}
							</div>
							<div class="flex-grow-1 overflow-hidden">
								<h6 class="mb-1 fw-bold text-truncate">{{ conv.user.userIdentifier }}</h6>
								<p class="text-muted small mb-0 text-truncate">
									{% if conv.lastMessage %}
										{{ conv.lastMessage.content }}
									{% else %}
										{{ "Nouvelle conversation"|trans }}
									{% endif %}
								</p>
							</div>
							{% if conv.lastMessage and activeUser and activeUser.id != conv.user.id and not conv.lastMessage.isRead and conv.lastMessage.recipient == app.user %}
								<div class="bg-primary rounded-circle" style="width: 10px; height: 10px;"></div>
							{% endif %}
						</a>
					{% else %}
						<div class="p-5 text-center text-muted">
							<i class="fas fa-comments fa-3x mb-3 opacity-25"></i>
							<p class="small">{{ "Aucune conversation active."|trans }}</p>
						</div>
					{% endfor %}
				</div>
			</div>

			{# Main Chat Area #}
			<div class="chat-main">
				{% if activeUser %}
					<div class="chat-header">
						<div class="d-flex align-items-center">
							<a href="{{ path('app_chat') }}" class="btn btn-light rounded-circle mobile-back-btn">
								<i class="fas fa-arrow-left"></i>
							</a>
							<div class="d-flex align-items-center gap-3">
								<div class="user-avatar" style="width: 40px; height: 40px; font-size: 0.9rem;">
									{% if activeUser.chercheur and activeUser.chercheur.photo %}
										<img src="{{ asset('uploads/profiles/' ~ activeUser.chercheur.photo) }}" alt="Avatar">
									{% else %}
										{{ activeUser.userIdentifier|slice(0, 1)|upper }}
									{% endif %}
								</div>
								<div>
									<h6 class="mb-0 fw-bold">{{ activeUser.userIdentifier }}</h6>
									<small class="text-success fw-bold">{{ 'En ligne'|trans }}</small>
								</div>
							</div>
						</div>
						<div>
							<button class="btn btn-light rounded-circle">
								<i class="fas fa-ellipsis-v text-muted"></i>
							</button>
						</div>
					</div>

					<div class="messages-container" id="messagesContainer">
						{% for message in messages %}
							<div class="d-flex flex-column {% if message.sender == app.user %}align-items-end{% else %}align-items-start{% endif %} mb-3">
								<div class="d-flex align-items-end gap-2 {% if message.sender == app.user %}flex-row-reverse{% endif %}">
									<div class="user-avatar shadow-sm" style="width: 30px; height: 30px; font-size: 0.7rem; border-radius: 8px;">
										{% if message.sender.chercheur and message.sender.chercheur.photo %}
											<img src="{{ asset('uploads/profiles/' ~ message.sender.chercheur.photo) }}" alt="Avatar">
										{% else %}
											{{ message.sender.userIdentifier|slice(0, 1)|upper }}
										{% endif %}
									</div>
									<div class="message-bubble mb-0 {% if message.sender == app.user %}message-sent{% else %}message-received{% endif %}">
										{{ message.content }}
									</div>
								</div>
								<div class="mt-1 px-5" style="font-size: 0.65rem; opacity: 0.7;">
									{{ message.createdAt|date('H:i') }}
								</div>
							</div>
						{% endfor %}
					</div>

					<div class="chat-input-area">
						<form action="{{ path('app_chat_send', {id: activeUser.id}) }}" method="POST">
							<input type="text" name="content" autocomplete="off" placeholder="{{ 'Écrivez votre message ici...'|trans }}" required>
							<button type="submit" class="send-btn">
								<i class="fas fa-paper-plane"></i>
							</button>
						</form>
					</div>
				{% else %}
					<div class="flex-grow-1 d-flex flex-column align-items-center justify-content-center text-muted p-5 text-center">
						<div class="glass-card p-5 rounded-circle mb-4" style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center;">
							<i class="fas fa-paper-plane fa-4x text-accent-primary opacity-25"></i>
						</div>
						<h4 class="fw-bold text-dark">{{ "Votre Messagerie"|trans }}</h4>
						<p class="max-w-md">{{ "Sélectionnez une conversation ou contactez un vendeur/candidat pour commencer à discuter."|trans }}</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<script>
		// Auto scroll to bottom
const container = document.getElementById('messagesContainer');
if (container) {
container.scrollTop = container.scrollHeight;
}

// Search functionality
const searchInput = document.getElementById('chatSearch');
const conversationItems = document.querySelectorAll('.conversation-item');

if (searchInput) {
searchInput.addEventListener('input', (e) => {
const term = e.target.value.toLowerCase();
conversationItems.forEach(item => {
const name = item.querySelector('h6').textContent.toLowerCase();
const lastMsg = item.querySelector('p').textContent.toLowerCase();
if (name.includes(term) || lastMsg.includes(term)) {
item.style.display = 'flex';
} else {
item.style.display = 'none';
}
});
});
}
	</script>
{% endblock %}
